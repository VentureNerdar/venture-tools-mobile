const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["./D-g6VyPT.js","./DLyjkqNI.js","./D0oBYrK6.js","./entry.UizA9sMz.css"])))=>i.map(i=>d[i]);
import{g as M,r as w,j as _,k as O,C as P,_ as F}from"./D0oBYrK6.js";import{a as B,F as b,L as E}from"./DLyjkqNI.js";import{s as l,a as g,b as k}from"./DXum9Cw4.js";const W=M("auth",()=>{const r=O(),y=w(null),u=w(null),c=w(""),p=w(!0);_();const L=async()=>{try{console.log("[AuthStore] Checking secure storage..."),p.value=!0,console.log("[AuthStore] Is Loading from auth store",p.value);const i=await l("authUser"),e=await l("Bearer");i!=null&&i.value&&(u.value=JSON.parse(i.value)),e!=null&&e.value&&(c.value=e.value),c.value&&!u.value&&(console.log("[AuthStore] Fetching user because token exists..."),await A()),p.value=!1}catch(i){console.error("[AuthStore] loadFromSecureStorage error:",i)}};async function A(){const e={Accept:"application/json","Content-Type":"application/json",Authorization:(await l("Bearer")).value||""},o=await $fetch(r.public.apiURL+"auth/user",{method:"GET",credentials:"include",headers:e}).catch(a=>{console.log(a)});o&&(y.value=o,u.value=o,await g("authUser",JSON.stringify(o)))}async function C(i){try{const e="mobile_"+crypto.randomUUID();let o=null;const a=P.getPlatform();try{const s=r.public.firebase.vapidKey;if(a==="web"){const{getMessaging:h,getToken:S,onMessage:t}=await F(async()=>{const{getMessaging:n,getToken:v,onMessage:m}=await import("./D-g6VyPT.js");return{getMessaging:n,getToken:v,onMessage:m}},__vite__mapDeps([0,1,2,3]),import.meta.url),d=h(B),f=await Notification.requestPermission();console.log("Web notification permission:",f),f==="granted"?(o=await S(d,{vapidKey:s}),console.log("Web FCM token:",o),o&&await g("notificationToken",o),t(d,n=>{var v,m;if(console.log("Web foreground message received:",JSON.stringify(n,null,2)),(v=n.notification)!=null&&v.title&&((m=n.notification)!=null&&m.body)){const{title:j,body:I}=n.notification;new Notification(j,{body:I,icon:"/logo-vertical.png"})}})):console.error("Web notification permission denied")}else{const{receive:h}=await b.requestPermissions();if(console.log("Android notification permission:",h),h!=="granted"){console.error("Android notification permissions denied");return}const S={vapidKey:s};o=(await b.getToken(S)).token,console.log("Android FCM token:",o),o&&g("notificationToken",o),b.addListener("notificationReceived",async t=>{var d,f;if(console.log("Android notification received:",JSON.stringify(t.notification,null,2)),(d=t.notification)!=null&&d.title&&((f=t.notification)!=null&&f.body))try{await E.schedule({notifications:[{id:Math.floor(Date.now()/1e3),title:t.notification.title,body:t.notification.body,smallIcon:"notification_icon"}]}),console.log("Local notification scheduled")}catch(n){console.error("Error scheduling local notification:",n)}else console.warn("Notification missing title or body:",t.notification)}),b.addListener("notificationActionPerformed",t=>{console.log("Android notification action:",JSON.stringify(t,null,2))})}}catch(s){console.error("FCM error:",s)}await g("deviceId",e);const R={Accept:"application/json","Content-Type":"application/json",Authorization:(await l("Bearer")).value||""};await $fetch(`${r.public.apiURL}users/id/${i}/devices`,{method:"POST",body:{device_id:e,device_type:a,device_name:a==="web"?navigator.userAgent:"Android Device",notification_token:o},headers:R}).catch(s=>{console.error("Error registering device with server:",s)})}catch(e){console.error("Error in registerDevice:",e)}}async function U(i){await $fetch(r.public.rootURL+"sanctum/csrf-cookie",{method:"GET",credentials:"include"});const e=await $fetch(r.public.apiURL+"login",{method:"POST",body:i,credentials:"include",headers:{Accept:"application/json","Content-Type":"application/json"}}).catch(o=>{console.log(o)});return e&&"token"in e&&(c.value="Bearer "+e.token,g("Bearer",c.value),await C(e.user.id),await A()),e}async function N(){const i=await l("Bearer"),e=await l("deviceId"),o=_(),a={Accept:"application/json","Content-Type":"application/json",Authorization:i.value||""};await $fetch(r.public.apiURL+"auth/logout",{method:"POST",credentials:"include",body:{device_id:e},headers:a}).catch(T=>{console.log(T)}),await k("Bearer"),await k("authUser"),await k("deviceId"),y.value=null,u.value=null,c.value="",o.replace({path:"/"})}return{user:y,authUser:u,token:c,isLoading:p,loadFromSecureStorage:L,login:U,fetchUser:A,logout:N}});export{W as u};
