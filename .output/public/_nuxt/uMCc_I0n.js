const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["./BR837W9e.js","./u7dc64rg.js","./WCNest2B.js","./entry.UizA9sMz.css"])))=>i.map(i=>d[i]);
import{g as j,r as y,j as A,k as I,C as M,_ as O}from"./WCNest2B.js";import{a as R,F as m,L as F}from"./u7dc64rg.js";import{S as t}from"./DYQiILsP.js";const D=j("auth",()=>{const c=I(),w=y(null),u=y(null),s=y(""),g=y(!0);A();const T=async()=>{try{console.log("[AuthStore] Checking secure storage..."),g.value=!0,console.log("[AuthStore] Is Loading from auth store",g.value);const i=await t.get({key:"authUser"}).catch(()=>null),e=await t.get({key:"Bearer"}).catch(()=>null);i!=null&&i.value&&(u.value=JSON.parse(i.value)),e!=null&&e.value&&(s.value=e.value),s.value&&!u.value&&(console.log("[AuthStore] Fetching user because token exists..."),await b()),g.value=!1}catch(i){console.error("[AuthStore] loadFromSecureStorage error:",i)}};async function b(){const e={Accept:"application/json","Content-Type":"application/json",Authorization:(await t.get({key:"Bearer"})).value||""},o=await $fetch(c.public.apiURL+"auth/user",{method:"GET",credentials:"include",headers:e}).catch(r=>{console.log(r)});o&&(w.value=o,u.value=o,await t.set({key:"authUser",value:JSON.stringify(o)}))}async function _(i){try{const e="mobile_"+crypto.randomUUID();let o=null;const r=M.getPlatform();try{const l=c.public.firebase.vapidKey;if(r==="web"){const{getMessaging:p,getToken:k,onMessage:n}=await O(async()=>{const{getMessaging:a,getToken:v,onMessage:h}=await import("./BR837W9e.js");return{getMessaging:a,getToken:v,onMessage:h}},__vite__mapDeps([0,1,2,3]),import.meta.url),d=p(R),f=await Notification.requestPermission();console.log("Web notification permission:",f),f==="granted"?(o=await k(d,{vapidKey:l}),console.log("Web FCM token:",o),o&&await t.set({key:"notificationToken",value:o}),n(d,a=>{var v,h;if(console.log("Web foreground message received:",JSON.stringify(a,null,2)),(v=a.notification)!=null&&v.title&&((h=a.notification)!=null&&h.body)){const{title:N,body:P}=a.notification;new Notification(N,{body:P,icon:"/logo-vertical.png"})}})):console.error("Web notification permission denied")}else{const{receive:p}=await m.requestPermissions();if(console.log("Android notification permission:",p),p!=="granted"){console.error("Android notification permissions denied");return}const k={vapidKey:l};o=(await m.getToken(k)).token,console.log("Android FCM token:",o),o&&await t.set({key:"notificationToken",value:o}),m.addListener("notificationReceived",async n=>{var d,f;if(console.log("Android notification received:",JSON.stringify(n.notification,null,2)),(d=n.notification)!=null&&d.title&&((f=n.notification)!=null&&f.body))try{await F.schedule({notifications:[{id:Math.floor(Date.now()/1e3),title:n.notification.title,body:n.notification.body,smallIcon:"notification_icon"}]}),console.log("Local notification scheduled")}catch(a){console.error("Error scheduling local notification:",a)}else console.warn("Notification missing title or body:",n.notification)}),m.addListener("notificationActionPerformed",n=>{console.log("Android notification action:",JSON.stringify(n,null,2))})}}catch(l){console.error("FCM error:",l)}await t.set({key:"deviceId",value:e});const U={Accept:"application/json","Content-Type":"application/json",Authorization:(await t.get({key:"Bearer"})).value||""};await $fetch(`${c.public.apiURL}users/id/${i}/devices`,{method:"POST",body:{device_id:e,device_type:r,device_name:r==="web"?navigator.userAgent:"Android Device",notification_token:o},headers:U}).catch(l=>{console.error("Error registering device with server:",l)})}catch(e){console.error("Error in registerDevice:",e)}}async function L(i){await $fetch(c.public.rootURL+"sanctum/csrf-cookie",{method:"GET",credentials:"include"});const e=await $fetch(c.public.apiURL+"login",{method:"POST",body:i,credentials:"include",headers:{Accept:"application/json","Content-Type":"application/json"}}).catch(o=>{console.log(o)});return e&&"token"in e&&(s.value="Bearer "+e.token,await t.set({key:"Bearer",value:s.value}),await _(e.user.id),await b()),e}async function C(){const i=await t.get({key:"Bearer"}),e=await t.get({key:"deviceId"}),o=A(),r={Accept:"application/json","Content-Type":"application/json",Authorization:i.value||""};await $fetch(c.public.apiURL+"auth/logout",{method:"POST",credentials:"include",body:{device_id:e},headers:r}).catch(S=>{console.log(S)}),w.value=null,u.value=null,s.value="",await t.remove({key:"Bearer"}),await t.remove({key:"authUser"}),await t.remove({key:"deviceId"}),o.replace({path:"/"})}return{user:w,authUser:u,token:s,isLoading:g,loadFromSecureStorage:T,login:L,fetchUser:b,logout:C}});export{D as u};
